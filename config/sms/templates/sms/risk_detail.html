{% load static %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>NAV | Detalle de Riesgo</title>
		<link href="{% static 'risk_detail.css' %}" rel="stylesheet" />
		<link href="{% static 'shared_components.css' %}" rel="stylesheet" />
		<link href="{% static 'sms_dashboard.css' %}" rel="stylesheet" />
	</head>

	<body>
		<div class="main-container">
			<div class="back-button">
				<a href="{% url 'sms:sms_dashboard' %}" class="button">&larr; Volver</a>
			</div>
			<div class="detail-header">
				<h1>Detalle de Riesgo</h1>
			</div>

			<div class="detail-content">
					<!-- Risk Information Section -->
					<div class="info-section">
						<h2 class="section-title">Información del Riesgo</h2>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Riesgo ID</span>
								<span class="info-value">{{ risk.id }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Estado</span>
								<span class="info-value">
									{% if risk.status == 'INTOLERABLE' %}
										<span class="status-badge status-intolerable">{{ risk.get_status_display }}</span>
									{% elif risk.status == 'TOLERABLE' %}
										<span class="status-badge status-tolerable">{{ risk.get_status_display }}</span>
									{% elif risk.status == 'ACCEPTABLE' %}
										<span class="status-badge status-aceptable">{{ risk.get_status_display }}</span>
									{% else %}
										<span class="status-badge status-not-evaluated">{{ risk.get_status_display }}</span>
									{% endif %}
								</span>
							</div>
							<div class="info-item">
								<span class="info-label">Condición</span>
								<span class="info-value">
									{% if risk.condition == 'MITIGATED' %}
										<span class="status-badge status-mitigated">{{ risk.get_condition_display }}</span>
									{% else %}
										<span class="status-badge status-unmitigated">{{ risk.get_condition_display }}</span>
									{% endif %}
								</span>
							</div>
							<div class="info-item">
								<span class="info-label">Fecha de creación</span>
								<span class="info-value">{{ risk.created_at|date:"d/m/Y" }}</span>
							</div>
						</div>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Reporte</span>
								<span class="info-value">{{ risk.report.code|default:"No registrado" }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Pre-evaluación</span>
								<span class="info-value">{{ risk.pre_evaluation }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Post-evaluación</span>
								<span class="info-value">
									{% if risk.post_evaluation_severity != '0' and risk.post_evaluation_probability != '0' %}
										{{ risk.post_evaluation_severity }}{{ risk.post_evaluation_probability }}
									{% else %}
										No evaluado
									{% endif %}
								</span>
							</div>
							<div class="info-item">
								<span class="info-label">Fecha de actualización</span>
								<span class="info-value">{{ risk.updated_at|date:"d/m/Y" }}</span>
							</div>
						</div>
						{% if risk.status == 'INTOLERABLE' and risk.condition == 'UNMITIGATED' %}
							<div class="critical-risk-warning">
								<span class="critical-risk-text">⚠️ RIESGO CRÍTICO</span>
							</div>
						{% endif %}
						<div class="info-item">
							<span class="info-label">Descripción</span>
							<div class="analysis-text">{{ risk.description }}</div>
						</div>
					</div>

					<!-- Actions Section -->
					<div class="reports-section-container">
						<div class="section-header header-centered">
							<h2>Acciones de Mitigación (MMR)</h2>
						</div>
						
						<div class="reports-list-container">
							<!-- Pending Actions -->
							{% if pending_actions %}
								{% for action in pending_actions %}
									<a href="{% url 'sms:action_detail' action.id %}" class="report-card-link">
										<div class="report-card">
											<div class="report-header">
												<div class="report-date-time">
													<span class="report-date">MMR ID: {{ action.id }}</span>
													<span class="report-time">Vence: {{ action.due_date|date:"d/m/Y" }}</span>
												</div>
												<div class="report-status-badge status-pending">
													{{ action.get_status_display }}
												</div>
											</div>
											
											<div class="report-content">
												<div class="report-data-section">
													<div class="report-data">
														<span class="report-label">Reporte:</span>
														<span class="report-value">{{ action.risk.report.code|default:"No registrado" }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Estado:</span>
														<span class="report-value">{{ action.get_status_display }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Fecha límite:</span>
														<span class="report-value">{{ action.due_date|date:"d/m/Y" }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Riesgo ID:</span>
														<span class="report-value">{{ action.risk.id }}</span>
													</div>
												</div>
												
												<div class="report-description">
													<span class="report-label">Descripción:</span>
													<p class="report-description-text">{{ action.description|truncatewords:30 }}</p>
												</div>
											</div>
										</div>
									</a>
								{% endfor %}
							{% endif %}

							<!-- Completed Actions -->
							{% if completed_actions %}
								{% for action in completed_actions %}
									<a href="{% url 'sms:action_detail' action.id %}" class="report-card-link">
										<div class="report-card">
											<div class="report-header">
												<div class="report-date-time">
													<span class="report-date">MMR ID: {{ action.id }}</span>
													<span class="report-time">Vence: {{ action.due_date|date:"d/m/Y" }}</span>
												</div>
												<div class="report-status-badge status-completed">
													{{ action.get_status_display }}
												</div>
											</div>
											
											<div class="report-content">
												<div class="report-data-section">
													<div class="report-data">
														<span class="report-label">Reporte:</span>
														<span class="report-value">{{ action.risk.report.code|default:"No registrado" }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Estado:</span>
														<span class="report-value">{{ action.get_status_display }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Riesgo ID:</span>
														<span class="report-value">{{ action.risk.id }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Fecha límite:</span>
														<span class="report-value">{{ action.due_date|date:"d/m/Y" }}</span>
													</div>
												</div>
												
												<div class="report-description">
													<span class="report-label">Descripción:</span>
													<p class="report-description-text">{{ action.description|truncatewords:30 }}</p>
												</div>
											</div>
										</div>
									</a>
								{% endfor %}
							{% endif %}

							<!-- Expired Actions -->
							{% if expired_actions %}
								{% for action in expired_actions %}
									<a href="{% url 'sms:action_detail' action.id %}" class="report-card-link">
										<div class="report-card">
											<div class="report-header">
												<div class="report-date-time">
													<span class="report-date">MMR ID: {{ action.id }}</span>
													<span class="report-time">Vence: {{ action.due_date|date:"d/m/Y" }}</span>
												</div>
												<div class="report-status-badge status-expired">
													{{ action.get_status_display }}
												</div>
											</div>
											
											<div class="report-content">
												<div class="report-data-section">
													<div class="report-data">
														<span class="report-label">Reporte:</span>
														<span class="report-value">{{ action.risk.report.code|default:"No registrado" }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Estado:</span>
														<span class="report-value">{{ action.get_status_display }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Riesgo ID:</span>
														<span class="report-value">{{ action.risk.id }}</span>
													</div>
													<div class="report-data">
														<span class="report-label">Fecha límite:</span>
														<span class="report-value">{{ action.due_date|date:"d/m/Y" }}</span>
													</div>
												</div>
												
												<div class="report-description">
													<span class="report-label">Descripción:</span>
													<p class="report-description-text">{{ action.description|truncatewords:30 }}</p>
												</div>
											</div>
										</div>
									</a>
								{% endfor %}
							{% endif %}

							{% if not pending_actions and not completed_actions and not expired_actions %}
								<div class="no-reports">
									<p>No hay acciones de mitigación registradas para este riesgo.</p>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
		</div>
	</body>
</html>

