{% load static %}
{% load sms_extras %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>NAV | Detalle del RVP</title>
		<link href="{% static 'voluntary_hazard_report_detail.css' %}" rel="stylesheet" />
		<link href="{% static 'shared_components.css' %}" rel="stylesheet" />
	</head>

	<body>
		<div class="main-container">
			<div class="detail-container">
                <div class="back-button">
                    <a href="{% url 'sms:sms_dashboard' %}" class="button">&larr; Volver</a>
                </div>
				<div class="detail-header">
					<h1>Detalle del RVP</h1>
				</div>

				<div class="detail-content">
					<!-- Report Information Section -->
					<div class="info-section">
						<h2 class="section-title">Información del Reporte</h2>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Fecha</span>
								<span class="info-value">{{ report.date|date:"d/m/Y" }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Hora</span>
								<span class="info-value">{{ report.time|time:"H:i" }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Área</span>
								<span class="info-value">{{ report.get_area_display }}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Rol del Reportante</span>
								<span class="info-value">{{ report.get_role_display|default:"No especificado" }}</span>
							</div>
						</div>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Nombre del Reportante</span>
								<span class="info-value">
									{% if report.is_anonymous == 'YES' %}
										Anónimo
									{% else %}
										{{ report.first_name|default:"No especificado" }}
									{% endif %}
								</span>
							</div>
							<div class="info-item">
								<span class="info-label">Apellido del Reportante</span>
								<span class="info-value">
									{% if report.is_anonymous == 'YES' %}
										Anónimo
									{% else %}
										{{ report.last_name|default:"No especificado" }}
									{% endif %}
								</span>
							</div>
						</div>
						<div class="info-item">
							<span class="info-label">Descripción del Peligro</span>
							<div class="analysis-text">{{ report.description }}</div>
						</div>
					</div>

					<!-- AI Analysis Results Section -->
					{% if ai_analysis %}
						<div class="info-section">
							<h2 class="section-title" id="ai-analysis-results-section">Resultados del Análisis de IA</h2>
							<div class="info-grid">
								<div class="info-item">
									<span class="info-label">Análisis válido</span>
									<span class="info-value">
										{% if is_valid %}
											<span style="color: #3be65a; font-weight: bold; background-color: rgb(76, 174, 79, 0.3); padding: 5px 10px; border-radius: 5px;">SÍ</span>
										{% else %}
											<span style="color: #f16b61; font-weight: bold; background-color: rgb(244, 67, 54, 0.3); padding: 5px 10px; border-radius: 5px;">NO</span>
										{% endif %}
									</span>
								</div>
								<div class="info-item">
									<span class="info-label">Estado del Análisis IA</span>
									<span class="info-value">{{ report.get_ai_analysis_status_display }}</span>
								</div>
							</div>
							{% if not is_valid %}
								<div class="info-item">
									<span class="info-label">Motivo de invalidación</span>
									<div class="invalidity-reason-text">{{ invalidity_reason|default:"No especificado" }}</div>
								</div>
							{% endif %}
						</div>

						<!-- Risks Section -->
						<div class="info-section">
							<h2 class="section-title">Análisis de Riesgos</h2>
							{% if risks %}
								<div class="risk-analysis-list">
								{% for risk_key, risk_data in risks.items %}
									<div class="risk-item">
										<div class="risk-header">
											<span class="risk-evaluation-badge {{ risk_data.evaluation|risk_color }}">{{ risk_data.evaluation|default:"N/A" }}</span>
											<span class="risk-key">{{ "Riesgo "|add:risk_key|cut:"risk" }}</span>
											{% if can_manage_sms %}
												<form
													method="post"
													action="{% url 'sms:delete_risk' report.id risk_key %}"
													class="risk-delete-form"
												>
													{% csrf_token %}
													<button
														type="submit"
														class="risk-delete-button"
														onclick="return confirm('¿Eliminar este riesgo y sus acciones asociadas?');"
													>
														X
													</button>
												</form>
											{% endif %}
										</div>
										<div class="risk-text">{{ risk_data.description|default:"Sin descripción" }}</div>
										{% if can_manage_sms %}
											{% with current_eval=risk_data.evaluation|default:"A1" %}
												{% with current_severity=current_eval|slice:":1" current_probability=current_eval|slice:"1:2" %}
													<form
														method="post"
														action="{% url 'sms:update_risk_evaluation' report.id risk_key %}"
														class="risk-evaluation-update-form"
													>
														{% csrf_token %}
														<div class="risk-evaluation-form-row">
															<div class="risk-evaluation-select-group">
																<label for="risk-evaluation-severity-{{ risk_key }}" class="risk-evaluation-label">Severidad</label>
																<select
																	id="risk-evaluation-severity-{{ risk_key }}"
																	name="severity"
																	class="risk-evaluation-select"
																	required
																>
																	<option value="A" {% if current_severity == "A" %}selected{% endif %}>A - Catastrófico</option>
																	<option value="B" {% if current_severity == "B" %}selected{% endif %}>B - Peligroso</option>
																	<option value="C" {% if current_severity == "C" %}selected{% endif %}>C - Grave</option>
																	<option value="D" {% if current_severity == "D" %}selected{% endif %}>D - Leve</option>
																	<option value="E" {% if current_severity == "E" %}selected{% endif %}>E - Insignificante</option>
																</select>
															</div>
															<div class="risk-evaluation-select-group">
																<label for="risk-evaluation-probability-{{ risk_key }}" class="risk-evaluation-label">Probabilidad</label>
																<select
																	id="risk-evaluation-probability-{{ risk_key }}"
																	name="probability"
																	class="risk-evaluation-select"
																	required
																>
																	<option value="1" {% if current_probability == "1" %}selected{% endif %}>1 - Sumamente improbable</option>
																	<option value="2" {% if current_probability == "2" %}selected{% endif %}>2 - Improbable</option>
																	<option value="3" {% if current_probability == "3" %}selected{% endif %}>3 - Remota</option>
																	<option value="4" {% if current_probability == "4" %}selected{% endif %}>4 - Ocasional</option>
																	<option value="5" {% if current_probability == "5" %}selected{% endif %}>5 - Frecuente</option>
																</select>
															</div>
															<button type="submit" class="risk-evaluation-update-button">Actualizar</button>
														</div>
													</form>
												{% endwith %}
											{% endwith %}
										{% endif %}
									</div>
								{% endfor %}
								</div>
							{% else %}
								<p class="no-risks-message">No hay riesgos registrados en el análisis actual.</p>
							{% endif %}

							{% if can_manage_sms %}
								<div class="risk-add-form">
									<h3>Agregar nuevo riesgo</h3>
									<form method="post" action="{% url 'sms:add_risk' report.id %}">
										{% csrf_token %}
										<label for="risk-description" class="risk-form-label">Descripción</label>
										<textarea
											id="risk-description"
											name="description"
											rows="3"
											class="risk-form-textarea"
											required
											placeholder="Describe el nuevo riesgo identificado...(mínimo 50 caracteres)"
											minlength="50"
											maxlength="1000"
										></textarea>
										<div class="risk-form-row">
											<div class="risk-select-group">
												<label for="risk-severity" class="risk-form-label">Severidad</label>
												<select id="risk-severity" name="severity" required>
													<option value="" selected disabled>Seleccione</option>
													<option value="A">A - Catastrófico</option>
													<option value="B">B - Peligroso</option>
													<option value="C">C - Grave</option>
													<option value="D">D - Leve</option>
													<option value="E">E</option>
												</select>
											</div>
											<div class="risk-select-group">
												<label for="risk-probability" class="risk-form-label">Probabilidad</label>
												<select id="risk-probability" name="probability" required>
													<option value="" selected disabled>Seleccione</option>
													<option value="1">1 - Sumamente improbable</option>
													<option value="2">2 - Improbable</option>
													<option value="3">3 - Remota</option>
													<option value="4">4 - Ocasional</option>
													<option value="5">5 - Frecuente</option>
												</select>
											</div>
										</div>
										<div class="risk-form-row" id="risk-submit-button-container">
											<button type="submit" class="risk-submit-button">Agregar riesgo</button>
										</div>
									</form>
								</div>
							{% endif %}
						</div>

						<!-- Actions Section -->
						<div class="info-section">
							<h2 class="section-title">Acciones de Mitigación</h2>
							{% if risk_entries %}
								<div class="recommendations-list">
									{% for risk_entry in risk_entries %}
										<div class="recommendation-item">
											<div class="recommendation-header">
												<span class="recommendation-risk-label">{{ "Riesgo "|add:risk_entry.key|cut:"risk" }} | Evaluación: {{ risk_entry.data.evaluation|default:"N/A" }}</span>
											</div>
											<ul class="action-list">
												{% if risk_entry.actions %}
													{% for action in risk_entry.actions %}
														<li class="action-item">
															<span class="action-text">{{ action }}</span>
															{% if can_manage_sms %}
																<form
																	method="post"
																	action="{% url 'sms:delete_action' report.id risk_entry.key forloop.counter0 %}"
																	class="action-delete-form"
																>
																	{% csrf_token %}
																	<button
																		type="submit"
																		class="action-delete-button"
																		onclick="return confirm('¿Eliminar esta acción?');"
																	>
																		X
																	</button>
																</form>
															{% endif %}
														</li>
													{% endfor %}
												{% else %}
													<li class="action-item action-item-empty">
														<span class="action-text">No hay acciones de mitigación registradas.</span>
													</li>
												{% endif %}
											</ul>
											{% if can_manage_sms %}
												<form
													method="post"
													action="{% url 'sms:add_action' report.id risk_entry.key %}"
													class="action-add-form"
												>
													{% csrf_token %}
													<label class="action-form-label" for="action-description-{{ risk_entry.key }}">Nueva acción</label>
													<textarea
														id="action-description-{{ risk_entry.key }}"
														name="description"
														rows="2"
														class="action-form-textarea"
														required
														placeholder="Describe la acción de mitigación...(mínimo 50 caracteres)"
													></textarea>
													<div class="action-form-row" id="action-submit-button-container">
														<button type="submit" class="action-submit-button">Agregar acción</button>
													</div>
												</form>
											{% endif %}
										</div>
									{% endfor %}
								</div>
							{% else %}
								<p class="no-actions-message">No se han definido riesgos para asociar acciones de mitigación.</p>
							{% endif %}
						</div>
					{% endif %}

					<!-- Analysis Metadata -->
					<div class="info-section">
						<h2 class="section-title">Información del Análisis</h2>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Fecha de Creación</span>
								<span class="info-value">
									{% if report.created_at %}
										{{ report.created_at|date:"d/m/Y H:i" }}
									{% else %}
										No disponible
									{% endif %}
								</span>
							</div>
							<div class="info-item">
								<span class="info-label">Última Actualización</span>
								<span class="info-value">
									{% if report.updated_at %}
										{{ report.updated_at|date:"d/m/Y H:i" }}
									{% else %}
										No disponible
									{% endif %}
								</span>
							</div>
						</div>
					</div>

					<!-- Modify Validity Section -->
					{% if can_manage_sms %}
						<div class="info-section">
							<h2 class="section-title">Modificar validez</h2>
							{% if not is_valid %}
								{% if not risks %}
									<p class="validity-warning-text">⚠️ No se puede validar el reporte sin al menos un riesgo registrado.</p>
								{% endif %}
								<form method="post" action="{% url 'sms:update_validity' report.id %}" class="validity-update-form">
									{% csrf_token %}
									<input type="hidden" name="new_validity" value="True">
									<label for="validity-reason" class="validity-form-label">Razón del cambio</label>
									<textarea
										id="validity-reason"
										name="reason"
										rows="3"
										class="validity-form-textarea"
										{% if not risks %}disabled{% endif %}
										placeholder="Indique el motivo para validar el reporte..."
									></textarea>
									<div class="validity-form-row">
										<button
											type="submit"
											class="validity-update-button"
											{% if not risks %}disabled{% endif %}
										>
											Actualizar a VÁLIDO
										</button>
									</div>
								</form>
							{% else %}
								<div class="validity-warning-box">
									<p class="validity-warning-text">⚠️ Al invalidar este reporte, se eliminarán todos los riesgos y acciones de mitigación asociadas.</p>
								</div>
								<form method="post" action="{% url 'sms:update_validity' report.id %}" class="validity-update-form">
									{% csrf_token %}
									<input type="hidden" name="new_validity" value="False">
									<label for="validity-reason" class="validity-form-label">Justificación de invalidación</label>
									<textarea
										id="validity-reason"
										name="reason"
										rows="3"
										maxlength="200"
										class="validity-form-textarea"
										required
										placeholder="Indique el motivo para invalidar el reporte..."
									></textarea>
									<div class="validity-form-row">
										<button type="submit" class="validity-update-button validity-update-button-danger">
											Invalidar reporte
										</button>
									</div>
								</form>
							{% endif %}
						</div>
					{% endif %}

					<!-- PDF Download Section -->
					<div class="info-section" id="register-section-container">
						<div class="register-container">
							<div class="register-text-container">
								{% if report.code %}
									<p id="register-warning-text" style="color: #f44336; font-weight: bold;">⚠️ Este reporte ya ha sido registrado con el código: <strong>{{ report.code }}</strong></p>
								{% else %}
									<p>Al registrar el reporte, se generará el PDF y se crearán las acciones de mitigación definidas
										en la sección "ACCIONES DE MITIGACIÓN".
									</p>
									<p id="register-warning-text">⚠️ IMPORTANTE: Esta acción no se puede deshacer.</p>
								{% endif %}
							</div>
							{% if not report.code %}
								<a href="{% url 'sms:register_rvp' report.id %}" class="register-button" target="_blank" onclick="return confirm('¿Está seguro que desea registrar este reporte? Esta acción generará el PDF y creará las acciones de mitigación en la base de datos. Esta acción no se puede deshacer.');">
									Registrar
								</a>
							{% else %}
								<a href="{% url 'sms:register_rvp' report.id %}" class="register-button" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;" title="Este reporte ya ha sido registrado">
									Registrado
								</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
