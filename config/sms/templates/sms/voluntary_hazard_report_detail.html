{% load static %}
{% load sms_extras %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>NAV | Detalle del RVP</title>
		<link href="{% static 'sms_base.css' %}" rel="stylesheet" />
		<link href="{% static 'voluntary_hazard_report_detail.css' %}" rel="stylesheet" />
	</head>

	<body>
		<div class="main-container">
            <div class="back-button">
				<a href="{{ back_url }}" class="button">&larr; Volver</a>
			</div>
			<div class="main-header">
				<h1>Detalle del RVP</h1>
			</div>

			<!-- Report Information Section -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Datos del Reporte</h2>
				</div>
				<div class="info-grid">
					<div class="info-item">
						<span class="info-label">Fecha</span>
						<span class="info-value">{{ report.date|date:"d/m/Y" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Nombre del Reportante</span>
						<span class="info-value">
							{% if report.is_anonymous == 'YES' %}
								Anónimo
							{% else %}
								{{ report.first_name|default:"No especificado" }} {{ report.last_name|default:"" }}
							{% endif %}
						</span>
					</div>
					<div class="info-item">
						<span class="info-label">Área</span>
						<span class="info-value">{{ report.get_area_display }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Hora</span>
						<span class="info-value">{{ report.time|time:"H:i" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Rol del Reportante</span>
						<span class="info-value">{{ report.get_role_display|default:"No especificado" }}</span>
					</div>
					<div class="info-item info-item-resolved">
						<span class="info-label">Resuelto</span>
						<span class="info-value">
							{% if report.is_resolved %}
								<span class="badge badge-green badge-medium">Sí</span>
							{% else %}
								<span class="badge badge-yellow badge-medium">No</span>
							{% endif %}
						</span>
					</div>
				</div>
				<div class="info-item">
					<span class="info-label">Descripción del Peligro</span>
					<div class="analysis-text">{{ report.description }}</div>
				</div>
			</div>

			<!-- AI Analysis Results Section -->
			{% if ai_analysis %}
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Resultados del Análisis de IA</h2>
					</div>
					<div class="info-grid info-grid-centered">
						<div class="info-item">
							<span class="info-label info-label-centered">Condición del Reporte</span>
							<span class="info-value info-value-centered">
								{% if is_valid %}
									<span class="badge badge-green badge-medium">VÁLIDO</span>
								{% else %}
									<span class="badge badge-red badge-medium">INVÁLIDO</span>
								{% endif %}
							</span>
						</div>
						<div class="info-item">
							<span class="info-label info-label-centered">Estatus del Análisis</span>
							<span class="info-value info-value-centered">{{ report.get_ai_analysis_status_display }}</span>
						</div>
					</div>
					{% if not is_valid %}
						<div class="info-item">
							<span class="info-label">Motivo de invalidación</span>
							<div class="invalidity-reason-text">{{ invalidity_reason|default:"No especificado" }}</div>
						</div>
					{% endif %}
				</div>

				<!-- Risks Section -->
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Análisis de Riesgos</h2>
					</div>
					{% if risks %}
						<div class="risk-analysis-list">
						{% for risk_key, risk_data in risks.items %}
							<div class="risk-item">
								<div class="risk-header">
									<span class="badge badge-medium {{ risk_data.evaluation|risk_color }}">{{ risk_data.evaluation|default:"N/A" }}</span>
									<span class="risk-key">{{ "Riesgo "|add:risk_key|cut:"risk" }}</span>
									{% if can_manage_sms and not report.is_processed %}
										<form
											method="post"
											action="{% url 'sms:delete_risk' report.id risk_key %}"
											class="risk-delete-form"
										>
											{% csrf_token %}
											<button
												type="submit"
												class="risk-delete-button"
												onclick="return confirm('¿Eliminar este riesgo y sus acciones asociadas?');"
											>
												X
											</button>
										</form>
									{% endif %}
								</div>
								<div class="risk-text">{{ risk_data.description|default:"Sin descripción" }}</div>
								{% if can_manage_sms and not report.is_processed %}
									{% with current_eval=risk_data.evaluation|default:"A1" %}
										{% with current_severity=current_eval|slice:":1" current_probability=current_eval|slice:"1:2" %}
											<form
												method="post"
												action="{% url 'sms:update_risk_evaluation' report.id risk_key %}"
												class="risk-evaluation-update-form"
											>
												{% csrf_token %}
												<div class="risk-evaluation-form-row">
													<div class="risk-evaluation-select-group">
														<label for="risk-evaluation-severity-{{ risk_key }}" class="risk-evaluation-label">Severidad</label>
														<select
															id="risk-evaluation-severity-{{ risk_key }}"
															name="severity"
															class="risk-evaluation-select"
															required
														>
															<option value="A" {% if current_severity == "A" %}selected{% endif %}>A - Catastrófico</option>
															<option value="B" {% if current_severity == "B" %}selected{% endif %}>B - Peligroso</option>
															<option value="C" {% if current_severity == "C" %}selected{% endif %}>C - Grave</option>
															<option value="D" {% if current_severity == "D" %}selected{% endif %}>D - Leve</option>
															<option value="E" {% if current_severity == "E" %}selected{% endif %}>E - Insignificante</option>
														</select>
													</div>
													<div class="risk-evaluation-select-group">
														<label for="risk-evaluation-probability-{{ risk_key }}" class="risk-evaluation-label">Probabilidad</label>
														<select
															id="risk-evaluation-probability-{{ risk_key }}"
															name="probability"
															class="risk-evaluation-select"
															required
														>
															<option value="1" {% if current_probability == "1" %}selected{% endif %}>1 - Sumamente improbable</option>
															<option value="2" {% if current_probability == "2" %}selected{% endif %}>2 - Improbable</option>
															<option value="3" {% if current_probability == "3" %}selected{% endif %}>3 - Remota</option>
															<option value="4" {% if current_probability == "4" %}selected{% endif %}>4 - Ocasional</option>
															<option value="5" {% if current_probability == "5" %}selected{% endif %}>5 - Frecuente</option>
														</select>
													</div>
													<button type="submit" class="risk-evaluation-update-button">Actualizar</button>
												</div>
											</form>
										{% endwith %}
									{% endwith %}
								{% endif %}
							</div>
						{% endfor %}
						</div>
					{% else %}
						<p class="no-risks-message">No hay riesgos registrados en el análisis actual.</p>
					{% endif %}

					{% if can_manage_sms and not report.is_processed %}
						<div class="risk-add-form">
							<h3>Agregar nuevo riesgo</h3>
							<form method="post" action="{% url 'sms:add_risk' report.id %}">
								{% csrf_token %}
								<label for="risk-description" class="risk-form-label">Descripción</label>
								<textarea
									id="risk-description"
									name="description"
									rows="3"
									class="risk-form-textarea"
									required
									placeholder="Describe el nuevo riesgo identificado...(mínimo 50 caracteres)"
									minlength="50"
									maxlength="1000"
								></textarea>
								<div class="risk-form-row">
									<div class="risk-select-group">
										<label for="risk-severity" class="risk-form-label">Severidad</label>
										<select id="risk-severity" name="severity" required>
											<option value="" selected disabled>Seleccione</option>
											<option value="A">A - Catastrófico</option>
											<option value="B">B - Peligroso</option>
											<option value="C">C - Grave</option>
											<option value="D">D - Leve</option>
											<option value="E">E</option>
										</select>
									</div>
									<div class="risk-select-group">
										<label for="risk-probability" class="risk-form-label">Probabilidad</label>
										<select id="risk-probability" name="probability" required>
											<option value="" selected disabled>Seleccione</option>
											<option value="1">1 - Sumamente improbable</option>
											<option value="2">2 - Improbable</option>
											<option value="3">3 - Remota</option>
											<option value="4">4 - Ocasional</option>
											<option value="5">5 - Frecuente</option>
										</select>
									</div>
								</div>
								<div class="risk-form-row" id="risk-submit-button-container">
									<button type="submit" class="risk-submit-button">Agregar riesgo</button>
								</div>
							</form>
						</div>
					{% endif %}
				</div>

				<!-- Actions Section -->
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Medidas de Mitigación de Riesgo (MMR)</h2>
					</div>
					{% if risk_entries %}
						<div class="recommendations-list">
							{% for risk_entry in risk_entries %}
								<div class="recommendation-item">
									<div class="recommendation-header">
										<span class="recommendation-risk-label">{{ "Riesgo "|add:risk_entry.key|cut:"risk" }} | Evaluación: {{ risk_entry.data.evaluation|default:"N/A" }}</span>
									</div>
									<ul class="action-list">
										{% if risk_entry.actions %}
											{% for action in risk_entry.actions %}
												<li class="action-item">
													<span class="action-text">{{ action }}</span>
													{% if can_manage_sms and not report.is_processed %}
														<form
															method="post"
															action="{% url 'sms:delete_action' report.id risk_entry.key forloop.counter0 %}"
															class="action-delete-form"
														>
															{% csrf_token %}
															<button
																type="submit"
																class="action-delete-button"
																onclick="return confirm('¿Eliminar esta acción?');"
															>
																X
															</button>
														</form>
													{% endif %}
												</li>
											{% endfor %}
										{% else %}
											<li class="action-item action-item-empty">
												<span class="action-text">No hay acciones de mitigación registradas.</span>
											</li>
										{% endif %}
									</ul>
									{% if can_manage_sms and not report.is_processed %}
										<form
											method="post"
											action="{% url 'sms:add_action' report.id risk_entry.key %}"
											class="action-add-form"
										>
											{% csrf_token %}
											<label class="action-form-label" for="action-description-{{ risk_entry.key }}">Nueva acción</label>
											<textarea
												id="action-description-{{ risk_entry.key }}"
												name="description"
												rows="2"
												class="action-form-textarea"
												required
												placeholder="Describe la acción de mitigación...(mínimo 50 caracteres)"
											></textarea>
											<div class="action-form-row" id="action-submit-button-container">
												<button type="submit" class="action-submit-button">Agregar acción</button>
											</div>
										</form>
									{% endif %}
								</div>
							{% endfor %}
						</div>
					{% else %}
						<p class="no-actions-message">No se han definido riesgos para asociar acciones de mitigación.</p>
					{% endif %}
				</div>
			{% endif %}

			<!-- Analysis Metadata -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Información del Análisis</h2>
				</div>
				<div class="info-grid info-grid-centered">
					<div class="info-item">
						<span class="info-label">Fecha de Creación</span>
						<span class="info-value">
							{% if report.created_at %}
								{{ report.created_at|date:"d/m/Y H:i" }}
							{% else %}
								No disponible
							{% endif %}
						</span>
					</div>
					<div class="info-item">
						<span class="info-label">Última Actualización</span>
						<span class="info-value">
							{% if report.updated_at %}
								{{ report.updated_at|date:"d/m/Y H:i" }}
							{% else %}
								No disponible
							{% endif %}
						</span>
					</div>
				</div>
			</div>

			<!-- Modify Validity Section -->
			{% if can_manage_sms %}
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Modificar validez</h2>
					</div>
					{% if not is_valid %}
						{% if not risks %}
							<p class="validity-warning-text">⚠️ No se puede validar el reporte sin al menos un riesgo registrado.</p>
						{% endif %}
						<form method="post" action="{% url 'sms:update_validity' report.id %}" class="validity-update-form">
							{% csrf_token %}
							<input type="hidden" name="new_validity" value="True">
							<label for="validity-reason" class="validity-form-label">Razón del cambio</label>
							<textarea
								id="validity-reason"
								name="reason"
								rows="3"
								class="validity-form-textarea"
								{% if not risks %}disabled{% endif %}
								placeholder="Indique el motivo para validar el reporte..."
							></textarea>
							<div class="validity-form-row">
								<button
									type="submit"
									class="validity-update-button"
									{% if not risks %}disabled{% endif %}
								>
									Actualizar a VÁLIDO
								</button>
							</div>
						</form>
					{% else %}
						<div class="validity-warning-box">
							<p class="validity-warning-text">⚠️ Al invalidar este reporte, se eliminarán todos los riesgos y acciones de mitigación asociadas.</p>
						</div>
						<form method="post" action="{% url 'sms:update_validity' report.id %}" class="validity-update-form">
							{% csrf_token %}
							<input type="hidden" name="new_validity" value="False">
							<label for="validity-reason" class="validity-form-label">Justificación de invalidación</label>
							<textarea
								id="validity-reason"
								name="reason"
								rows="3"
								maxlength="200"
								class="validity-form-textarea"
								{% if report.code %}disabled{% else %}required{% endif %}
								placeholder="Indique el motivo para invalidar el reporte..."
							></textarea>
							<div class="validity-form-row">
								<button type="submit" class="validity-update-button validity-update-button-danger" {% if report.code %}disabled{% endif %}>
									Invalidar reporte
								</button>
							</div>
						</form>
					{% endif %}
				</div>
			{% endif %}

			<!-- Register Section -->
			<div class="cards-container" id="register-section-container">
				<div class="cards-container-header">
					<h2>Registrar reporte</h2>
				</div>
				<div class="register-container">
					<div class="register-text-container">
						{% if report.code %}
							<p id="register-warning-text">⚠️ Este reporte ya ha sido registrado con el código: {{ report.code }}</p>
						{% else %}
							<p>Al registrar el reporte, se le asignará el código único de registro para la BD y se generará la planilla en formato PDF.</p>
							<p id="register-warning-text">⚠️ IMPORTANTE: Esta acción no se puede deshacer.</p>
						{% endif %}
					</div>
					<div class="buttons-container">
						<div class="button">
							{% if not report.code %}
								<a 
								href="{% url 'sms:register_vhr' report.id %}" 
								class="register-button" 
								onclick="return confirm('⚠️ ¿Está seguro que desea registrar este reporte? Esta acción no se puede deshacer.');">
									Registrar
								</a>
							{% else %}
								<a 
								href="{% url 'sms:register_vhr' report.id %}" 
								class="register-button" 
								style="opacity: 0.5; cursor: not-allowed; pointer-events: none;" 
								title="Este reporte ya ha sido registrado">
									Registrado
								</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

			<!-- MMRs Creation Section -->
			<div class="cards-container" id="register-section-container">
				<div class="cards-container-header">
					<h2>Procesar reporte</h2>
				</div>
				<div class="register-container">
					<div class="register-text-container">
						{% if report.is_processed %}
							<p id="register-warning-text">⚠️ El reporte ya ha sido procesado.</p>
						{% else %}
							<p>Al presionar el botón se crearán las MMRs definidas previamente.</p>
							<p id="register-warning-text">⚠️ IMPORTANTE: Esta acción no se puede deshacer.</p>
						{% endif %}
					</div>
					<div class="buttons-container">
						<div class="button">
							{% if report.is_registered and not report.is_processed %}
								<a 
								href="{% url 'sms:process_vhr' report.id %}" 
								class="register-button" 
								onclick="return confirm('⚠️ ¿Está seguro que desea procesar este reporte? Esta acción no se puede deshacer.');">
									Procesar
								</a>
							{% else %}
								<span class="register-button" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">Procesado</span>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		
		{% if should_download_pdf %}
		<script>
			// Auto-trigger PDF download after page loads
			window.addEventListener('load', function() {
				setTimeout(function() {
					window.location.href = "{% url 'sms:download_vhr_pdf' report.id %}";
				}, 500); // Small delay to ensure page is fully loaded
			});
		</script>
		{% endif %}
	</body>
</html>
