{% load static %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>NAV | Detalle de MMR</title>
		<link href="{% static 'sms_base.css' %}" rel="stylesheet" />
		<link href="{% static 'action_detail.css' %}" rel="stylesheet" />
		<script src="{% static 'js/action_detail_dynamics.js' %}"></script>
	</head>

	<body>
		<div class="main-container">
			<div class="back-button">
				<button onclick="goBack()" class="button">&larr; Volver</button>
			</div>
			<div class="main-header">
				<h1>Detalle de MMR</h1>
			</div>

			<!-- Action Information Section -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Datos de la MMR</h2>
				</div>
				<div class="info-grid">
					<div class="info-item">
						<span class="info-label">MMR ID</span>
						<span class="info-value">{{ action.id }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Riesgo ID</span>
						<span class="info-value">{{ action.risk.id }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Estatus del Riesgo</span>
						<span class="info-value">{{ action.risk.get_status_display }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Fecha de creación</span>
						<span class="info-value">{{ action.created_at|date:"d/m/Y" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Reporte</span>
						<span class="info-value">{{ action.risk.report.code|default:"No registrado" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Estatus</span>
						<span class="info-value">
							{% if action.status == 'COMPLETED' %}
								<span class="badge badge-green badge-medium">{{ action.get_status_display }}</span>
							{% else %}
								<span class="badge badge-red badge-medium">{{ action.get_status_display }}</span>
							{% endif %}
						</span>
					</div>
				</div>
				<div class="info-item">
					<span class="info-label">Descripción</span>
					<div class="analysis-text">{{ action.description }}</div>
				</div>
			</div>

			<!-- Notes Section -->
			{% if can_manage_sms %}
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Notas</h2>
					</div>
					{% if action.status == 'COMPLETED' %}
						{% if action.notes %}
							<div class="analysis-text">{{ action.notes }}</div>
						{% else %}
							<div class="analysis-text" style="color: rgba(255, 255, 255, 0.5); font-style: italic;">No hay notas registradas.</div>
						{% endif %}
						<p class="readonly-notice">⚠️ Esta medida está completada. Las notas no pueden ser modificadas.</p>
					{% else %}
						<form method="post" action="{% url 'sms:update_action_notes' action.id %}" class="notes-form">
							{% csrf_token %}
							<textarea
								name="notes"
								rows="5"
								maxlength="200"
								class="notes-textarea"
								placeholder="Agregar notas sobre esta medida de mitigación..."
							>{{ action.notes|default:"" }}</textarea>
							<div class="form-row">
								<button type="submit" class="update-button">Guardar notas</button>
							</div>
						</form>
					{% endif %}
				</div>
			{% else %}
				{% if action.notes %}
					<div class="cards-container">
						<div class="cards-container-header">
							<h2>Notas</h2>
						</div>
						<div class="analysis-text">{{ action.notes }}</div>
					</div>
				{% endif %}
			{% endif %}

			<!-- Evidences Section -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Evidencias de la MMR</h2>
				</div>
				{% if evidences %}
					<ul class="action-list">
						{% for evidence in evidences %}
							<li class="action-item">
								<span class="action-text">{{ evidence.description }}</span>
								{% if can_manage_sms and action.status != 'COMPLETED' %}
									<form
										method="post"
										action="{% url 'sms:delete_evidence' action.id evidence.id %}"
										class="action-delete-form"
									>
										{% csrf_token %}
										<button
											type="submit"
											class="action-delete-button"
											onclick="return confirm('¿Eliminar esta evidencia?');"
										>
											X
										</button>
									</form>
								{% endif %}
							</li>
						{% endfor %}
					</ul>
				{% else %}
					<ul class="action-list">
						<li class="action-item action-item-empty">
							<span class="action-text">No hay evidencias registradas.</span>
						</li>
					</ul>
				{% endif %}
				{% if can_manage_sms and action.status != 'COMPLETED' %}
					<form
						method="post"
						action="{% url 'sms:add_evidence' action.id %}"
						class="action-add-form"
					>
						{% csrf_token %}
						<label class="action-form-label" for="evidence-description">Nueva evidencia</label>
						<textarea
							id="evidence-description"
							name="description"
							rows="2"
							class="action-form-textarea"
							required
							placeholder="Describe la evidencia...(mínimo 10 caracteres)"
						></textarea>
						<div class="form-row">
							<button type="submit" class="action-add-button">Agregar evidencia</button>
						</div>
					</form>
				{% endif %}
			</div>

			<!-- Update Due Date and Responsible Section -->
			{% if can_manage_sms and action.status != 'COMPLETED' %}
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Fecha Límite y Responsable</h2>
					</div>
					<div class="due-date-responsible-form">
						<form method="post" action="{% url 'sms:update_action_due_date' action.id %}" class="due-date-form">
							{% csrf_token %}
							<div class="form-field-group">
								<label for="due_date" class="form-label">Fecha Límite</label>
								<input
									type="date"
									name="due_date"
									id="due_date"
									class="date-input"
									value="{{ action.due_date|date:'Y-m-d' }}"
									required
								/>
								<div class="form-row">
									<button type="submit" class="update-button">Actualizar Fecha</button>
								</div>
							</div>
						</form>
						<form method="post" action="{% url 'sms:update_action_responsible' action.id %}" class="responsible-form">
							{% csrf_token %}
							<div class="form-field-group">
								<label for="responsible" class="form-label">Responsable</label>
								<select
									name="responsible"
									id="responsible"
									class="date-input"
									required
								>
									<option value="">Seleccione un responsable</option>
									{% for user in available_users %}
										<option value="{{ user.id }}" {% if action.responsible and action.responsible.id == user.id %}selected{% endif %}>
											{{ user.first_name }} {{ user.last_name }} ({{ user.get_role_display }})
										</option>
									{% endfor %}
								</select>
								<div class="form-row">
									<button type="submit" class="update-button">Actualizar Responsable</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			{% elif action.status == 'COMPLETED' %}
				<div class="cards-container">
					<div class="cards-container-header">
						<h2>Fecha Límite y Responsable</h2>
					</div>
					<div class="info-grid">
						<div class="info-item">
							<span class="info-label">Fecha Límite</span>
							<span class="info-value">{{ action.due_date|date:"d/m/Y" }}</span>
						</div>
						<div class="info-item">
							<span class="info-label">Responsable</span>
							<span class="info-value">
								{% if action.responsible %}
									{{ action.responsible.first_name }} {{ action.responsible.last_name }} ({{ action.responsible.get_role_display }})
								{% else %}
									No asignado
								{% endif %}
							</span>
						</div>
					</div>
					<p class="readonly-notice">⚠️ Esta medida está completada. La fecha límite y el responsable no pueden ser modificados.</p>
				</div>
			{% endif %}

			<!-- Mark as Completed Section -->
			{% if can_manage_sms and action.status != 'COMPLETED' %}
				{% if evidences %}
					<div class="cards-container">
						<div class="cards-container-header">
							<h2>Marcar como Completada</h2>
						</div>
						<div class="warning-box">
							<p class="warning-text">⚠️ <strong>IMPORTANTE:</strong> Al marcar esta MMR como completada:</p>
							<ul class="warning-list">
								<li>El estado cambiará permanentemente a "Completada"</li>
								<li>Las notas y la fecha límite <strong>NO podrán ser modificadas</strong> después de esta acción</li>
								<li>Esta acción <strong>NO puede ser revertida</strong></li>
							</ul>
						</div>
						<form method="post" action="{% url 'sms:mark_action_completed' action.id %}" class="complete-form">
							{% csrf_token %}
							<div class="form-row">
								<button type="submit" class="complete-button" onclick="return confirm('⚠️ ADVERTENCIA: Al marcar esta MMR como completada, las notas y la fecha límite no podrán ser modificadas y esta acción no puede ser revertida.\n\n¿Está seguro que desea continuar?');">
									Marcar como completada
								</button>
							</div>
						</form>
					</div>
				{% else %}
					<div class="cards-container">
						<div class="cards-container-header">
							<h2>Marcar como Completada</h2>
						</div>
						<p class="warning-text">⚠️ <strong>IMPORTANTE:</strong> No hay evidencias registradas para esta MMR.</p>
					</div>
				{% endif %}
			{% endif %}
		</div>
	</body>
</html>

