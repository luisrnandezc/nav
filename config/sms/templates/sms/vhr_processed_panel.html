{% load static %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>NAV | Detalle de RVP procesado</title>
		<link href="{% static 'sms_base.css' %}" rel="stylesheet" />
		<link href="{% static 'vhr_processed_panel.css' %}" rel="stylesheet" />
		<script src="{% static 'js/vhr_processed_panel_dynamics.js' %}"></script>
	</head>

	<body>
		<div class="main-container">
			<div class="back-button">
				<a href="{{ back_url }}" class="button">&larr; Volver</a>
			</div>
			<div class="main-header">
				<h1>Detalle del RVP</h1>
			</div>

			<!-- Report Information Section -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Datos del RVP</h2>
				</div>
				<div class="info-grid">
					<div class="info-item">
						<span class="info-label">Código de Registro</span>
						<span class="info-value">{{ report.code|default:"No registrado" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Fecha</span>
						<span class="info-value">{{ report.date|date:"d/m/Y" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Hora</span>
						<span class="info-value">{{ report.time|time:"H:i" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Área</span>
						<span class="info-value">{{ report.get_area_display }}</span>
					</div>
				</div>
				<div class="info-grid">
					<div class="info-item">
						<span class="info-label">Rol del Reportante</span>
						<span class="info-value">{{ report.get_role_display|default:"No especificado" }}</span>
					</div>
					<div class="info-item">
						<span class="info-label">Reportante</span>
						<span class="info-value">
							{% if report.is_anonymous == 'YES' %}
								Anónimo
							{% else %}
								{{ report.first_name|default:"No especificado" }} {{ report.last_name|default:"" }}
							{% endif %}
						</span>
					</div>
					<div class="info-item">
						<span class="info-label">Estatus</span>
						<span class="info-value">
							{% if report.is_resolved %}
								<span class="badge badge-green badge-medium">RESUELTO</span>
							{% else %}
								<span class="badge badge-red badge-medium">NO RESUELTO</span>
							{% endif %}
						</span>
					</div>
					<div class="info-item">
						<span class="info-label">Validez</span>
						<span class="info-value">
							{% if report.is_valid %}
								<span class="badge badge-green badge-medium">VÁLIDO</span>
							{% else %}
								<span class="badge badge-red badge-medium">INVÁLIDO</span>
							{% endif %}
						</span>
					</div>
				</div>
				<div class="info-item">
					<span class="info-label">Descripción del Peligro</span>
					<div class="analysis-text">{{ report.description }}</div>
				</div>
			</div>

			<!-- Risks Section -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Riesgos</h2>
				</div>
				
				<div class="reports-list-container">
					{% if risks %}
						{% for risk in risks %}
							<a href="{% url 'sms:risk_detail' risk.id %}" class="report-card-link">
								<div class="report-card">
									<div class="report-header">
										<div class="report-date-time">
											<span class="report-date">Riesgo ID: {{ risk.id }}</span>
										</div>
										{% if risk.status == 'INTOLERABLE' and risk.condition == 'UNMITIGATED' %}
											<div class="badge badge-red badge-medium">
												SIN MITIGAR
											</div>
										{% elif risk.condition == 'MITIGATED' %}
											<div class="badge badge-green badge-medium">
												MITIGADO
											</div>
										{% else %}
											<div class="badge badge-orange badge-medium">
												SIN MITIGAR
											</div>
										{% endif %}
									</div>
									
									<div class="report-content">
										{% if risk.status == 'INTOLERABLE' and risk.condition == 'UNMITIGATED' %}
											<div class="critical-risk-warning">
												<span class="critical-risk-text">⚠️ RIESGO CRÍTICO</span>
											</div>
										{% endif %}
										<div class="report-data-section">
											<div class="report-data">
												<span class="report-label">Reporte:</span>
												<span class="report-value">{{ risk.report.code|default:"No registrado" }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Pre-evaluación:</span>
												<span class="report-value">{{ risk.pre_evaluation }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Condición:</span>
												{% if risk.condition == 'UNMITIGATED' %}
													<span class="report-value">SIN MITIGAR</span>
												{% else %}
													<span class="report-value">MITIGADO</span>
												{% endif %}
											</div>
											<div class="report-data">
												<span class="report-label">Creado:</span>
												<span class="report-value">{{ risk.created_at|date:"d/m/Y" }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Post-evaluación:</span>
												<span class="report-value">{{ risk.post_evaluation }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Estatus:</span>
												<span class="report-value">{{ risk.get_status_display }}</span>
											</div>
										</div>
										
										<div class="report-description">
											<span class="report-label">Descripción:</span>
											<p class="report-description-text">{{ risk.description|truncatewords:30 }}</p>
										</div>
									</div>
								</div>
							</a>
						{% endfor %}
					{% else %}
						<div class="no-reports">
							<p>No hay riesgos registrados para este reporte.</p>
						</div>
					{% endif %}
				</div>
			</div>

			<!-- Actions Section -->
			<div class="cards-container">
				<div class="cards-container-header">
					<h2>Medidas de Mitigación de Riesgo (MMR)</h2>
				</div>
				
				<div class="reports-list-container">
					<!-- Expired MMRs -->
					{% if expired_actions %}
						{% for action in expired_actions %}
							<a href="{% url 'sms:action_detail' action.id %}" class="report-card-link">
								<div class="report-card">
									<div class="report-header">
										<div class="report-date-time">
											<span class="report-date">MMR ID: {{ action.id }}</span>
										</div>
										{% if action.risk.status == 'INTOLERABLE' %}
											<div class="badge badge-red badge-medium">
												{{ action.get_status_display }}
											</div>
										{% else %}
											<div class="badge badge-yellow badge-medium">
												{{ action.get_status_display }}
											</div>
										{% endif %}
									</div>
									
									<div class="report-content">
										<div class="report-data-section actions-data-section">
											<div class="report-data">
												<span class="report-label">Reporte:</span>
												<span class="report-value">{{ action.risk.report.code|default:"No registrado" }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Riesgo ID:</span>
												<span class="report-value">{{ action.risk.id }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Responsable:</span>
												{% if action.responsible %}
													<span class="report-value">{{ action.responsible.first_name }} {{ action.responsible.last_name }}</span>
												{% else %}
													<span class="report-value">No asignado</span>
												{% endif %}
											</div>
											<div class="report-data">
												<span class="report-label">Fecha límite:</span>
												<span class="report-value">{{ action.due_date|date:"d/m/Y" }}</span>
											</div>
										</div>

										<div class="report-description">
											<span class="report-label">Descripción:</span>
											<p class="report-description-text">{{ action.description|truncatewords:30 }}</p>
										</div>
									</div>
								</div>
							</a>
						{% endfor %}
					{% endif %}

					<!-- Pending Actions -->
					{% if pending_actions %}
						{% for action in pending_actions %}
							<a href="{% url 'sms:action_detail' action.id %}" class="report-card-link">
								<div class="report-card">
									<div class="report-header">
										<div class="report-date-time">
											<span class="report-date">MMR ID: {{ action.id }}</span>
										</div>
										{% if action.risk.status == 'INTOLERABLE' %}
											<div class="badge badge-red badge-medium">
												{{ action.get_status_display }}
											</div>
										{% else %}
											<div class="badge badge-yellow badge-medium">
												{{ action.get_status_display }}
											</div>
										{% endif %}
									</div>
									
									<div class="report-content">
										<div class="report-data-section actions-data-section">
											<div class="report-data">
												<span class="report-label">Reporte:</span>
												<span class="report-value">{{ action.risk.report.code|default:"No registrado" }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Riesgo ID:</span>
												<span class="report-value">{{ action.risk.id }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Responsable:</span>
												{% if action.responsible %}
													<span class="report-value">{{ action.responsible.first_name }} {{ action.responsible.last_name }}</span>
												{% else %}
													<span class="report-value">No asignado</span>
												{% endif %}
											</div>
											<div class="report-data">
												<span class="report-label">Fecha límite:</span>
												<span class="report-value">{{ action.due_date|date:"d/m/Y" }}</span>
											</div>
										</div>
										
										<div class="report-description">
											<span class="report-label">Descripción:</span>
											<p class="report-description-text">{{ action.description|truncatewords:30 }}</p>
										</div>
									</div>
								</div>
							</a>
						{% endfor %}
					{% endif %}

					<!-- Completed Actions -->
					{% if completed_actions %}
						{% for action in completed_actions %}
							<a href="{% url 'sms:action_detail' action.id %}" class="report-card-link">
								<div class="report-card">
									<div class="report-header">
										<div class="report-date-time">
											<span class="report-date">MMR ID: {{ action.id }}</span>
										</div>
										<div class="badge badge-green badge-medium">
											{{ action.get_status_display }}
										</div>
									</div>
									
									<div class="report-content">
										<div class="report-data-section actions-data-section">
											<div class="report-data">
												<span class="report-label">Reporte:</span>
												<span class="report-value">{{ action.risk.report.code|default:"No registrado" }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Riesgo ID:</span>
												<span class="report-value">{{ action.risk.id }}</span>
											</div>
											<div class="report-data">
												<span class="report-label">Responsable:</span>
												{% if action.responsible %}
													<span class="report-value">{{ action.responsible.first_name }} {{ action.responsible.last_name }}</span>
												{% else %}
													<span class="report-value">No asignado</span>
												{% endif %}
											</div>
											<div class="report-data">
												<span class="report-label">Fecha límite:</span>
												<span class="report-value">{{ action.due_date|date:"d/m/Y" }}</span>
											</div>
										</div>
										
										<div class="report-description">
											<span class="report-label">Descripción:</span>
											<p class="report-description-text">{{ action.description|truncatewords:30 }}</p>
										</div>
									</div>
								</div>
							</a>
						{% endfor %}
					{% endif %}

					{% if not pending_actions and not completed_actions and not expired_actions %}
						<div class="no-reports">
							<p>No hay MMR registradas para este reporte.</p>
						</div>
					{% endif %}
				</div>
			</div>

			<!-- Risk Evaluation Registry Section -->
			{% if can_manage_sms %}
				<div class="cards-container" id="register-section-container">
					<div class="cards-container-header">
						<h2>Registro de Evaluación de Riesgos (RER)</h2>
					</div>
					<div class="register-container">
						<div class="register-text-container">
							{% if can_be_registered %}
								<p id="register-info-text">✅ Listo para generar el Registro de Evaluación de Riesgos.</p>
							{% else %}
								<p id="register-info-text">⚠️ Todas las MMR deben tener un responsable y fecha límite asignada.</p>
							{% endif %}
						</div>
						<div class="buttons-container">
							<div class="button">
								{% if can_be_registered %}
									<a 
									href="{% url 'sms:rer_form' report.id %}" 
									class="register-button" 
									onclick="return confirm('⚠️ Esto enviará la solicitud del RER a SARA con toda la.');">
										+Generar RER
									</a>
								{% else %}
									<a 
									href="{% url 'sms:rer_form' report.id %}" 
									class="register-button" 
									style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
										+Generar RER
									</a>
								{% endif %}
							</div>
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	</body>
</html>

